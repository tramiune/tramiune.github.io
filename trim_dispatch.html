<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Trim Video (GitHub Actions)</title>
    <style>
        :root{--bd:#e7e7e7;--mut:#666}
        body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;padding:14px}
        .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
        input,select{padding:8px 10px;border:1px solid var(--bd);border-radius:10px}
        button,a.btn{
          padding:8px 10px;border:1px solid var(--bd);background:#fff;border-radius:10px;cursor:pointer;
          text-decoration:none;color:inherit;display:inline-flex;gap:6px;align-items:center
        }
        button:hover,a.btn:hover{background:#f5f5f5}
        .mut{color:var(--mut);font-size:12px;white-space:pre-wrap}
        .k{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
        .card{border:1px solid var(--bd);border-radius:14px;padding:12px;max-width:900px}
        hr{border:none;border-top:1px solid var(--bd);margin:12px 0}
        .warn{border:1px solid #f0c1c1;background:#fff6f6;padding:8px 10px;border-radius:12px;font-size:12px;color:#7a2a2a;margin-top:10px}
        .ok{border:1px solid #cfe7cf;background:#f6fff6;color:#1f5f1f}
    </style>
</head>
<body>
<div class="card">
    <div class="row" style="justify-content:space-between">
        <b>Trim MP4 & Replace (server-side via GitHub Actions)</b>
        <div class="row">
            <a class="btn k" href="./browser.html">‚Üê back</a>
            <a class="btn k" id="openActions" href="#" target="_blank" rel="noreferrer">Open Actions</a>
        </div>
    </div>

    <p class="mut">
        - Kh√¥ng ch·∫°y FFmpeg trong browser ‚Üí h·∫øt l·ªói <b>bad memory</b>
        - Runner s·∫Ω ch·∫°y ffmpeg r·ªìi commit ƒë√® file mp4 c≈©
        - Xem ti·∫øn tr√¨nh trong tab Actions c·ªßa repo
    </p>

    <div class="row">
        <input id="token" type="password" placeholder="GitHub Token (workflow dispatch + contents write)" style="min-width:320px"/>
        <label class="mut"><input id="remember" type="checkbox"/> remember token</label>
        <button id="fillFromQuery">‚Ü∫ Fill from URL query</button>
    </div>

    <hr/>

    <div class="row">
        <input id="folder" placeholder="folder (vd: 101_anime)" style="min-width:240px"/>
        <input id="file" placeholder="file (vd: anime_001.mp4)" style="min-width:260px"/>
    </div>

    <div class="row" style="margin-top:10px">
        <input id="start" type="number" step="0.1" min="0" placeholder="start (sec)" />
        <input id="end" type="number" step="0.1" min="0" placeholder="end (sec)" />
        <select id="mode" title="FAST: stream copy / PRECISE: re-encode video">
            <option value="FAST">FAST (copy stream)</option>
            <option value="PRECISE">PRECISE (re-encode video)</option>
        </select>
        <input id="crf" type="number" step="1" min="16" max="35" value="23" title="CRF (only PRECISE)"/>
        <button id="go">üöÄ Dispatch trim job</button>
    </div>

    <div class="warn" id="warnBox" style="display:none"></div>
    <div class="mut" id="status" style="margin-top:10px"></div>
</div>

<script>
    const OWNER="tramiune";
    const REPO="tramiune001_res_wallpaper";
    const BRANCH="main";
    const WORKFLOW_FILE="trim_video.yml"; // .github/workflows/trim_video.yml

    const tokenEl=document.getElementById("token");
    const rememberEl=document.getElementById("remember");
    const statusEl=document.getElementById("status");
    const warnBox=document.getElementById("warnBox");

    const folderEl=document.getElementById("folder");
    const fileEl=document.getElementById("file");
    const startEl=document.getElementById("start");
    const endEl=document.getElementById("end");
    const modeEl=document.getElementById("mode");
    const crfEl=document.getElementById("crf");

    const openActions=document.getElementById("openActions");
    openActions.href = `https://github.com/${OWNER}/${REPO}/actions`;

    function setStatus(s){ statusEl.textContent=s||""; }
    function setWarn(s){
      if(!s){ warnBox.style.display="none"; warnBox.textContent=""; return; }
      warnBox.style.display="block"; warnBox.textContent=s;
    }
    function qs(){ return new URLSearchParams(location.search); }

    // share token with browser.html
    const LS_KEY=`wallpaper_browser_token_${OWNER}_${REPO}`;
    (function initToken(){
      const saved=localStorage.getItem(LS_KEY);
      if(saved){ tokenEl.value=saved; rememberEl.checked=true; }
      rememberEl.addEventListener("change",()=>{
        if(rememberEl.checked){
          if(tokenEl.value.trim()) localStorage.setItem(LS_KEY, tokenEl.value.trim());
        } else localStorage.removeItem(LS_KEY);
      });
      tokenEl.addEventListener("input",()=>{
        if(rememberEl.checked) localStorage.setItem(LS_KEY, tokenEl.value.trim());
      });
    })();

    function getToken(){
      const t=(tokenEl.value||"").trim();
      if(!t) throw new Error("Ch∆∞a nh·∫≠p token.");
      return t;
    }

    async function dispatchWorkflow(inputs){
      const token=getToken();
      const url=`https://api.github.com/repos/${OWNER}/${REPO}/actions/workflows/${encodeURIComponent(WORKFLOW_FILE)}/dispatches`;

      const res=await fetch(url,{
        method:"POST",
        headers:{
          "Authorization":`Bearer ${token}`,
          "Accept":"application/vnd.github+json",
          "Content-Type":"application/json"
        },
        body: JSON.stringify({ ref: BRANCH, inputs })
      });

      if(!res.ok){
        const txt=await res.text().catch(()=> "");
        throw new Error(`Dispatch failed: HTTP ${res.status}\n${txt}`);
      }
    }

    function fillFromQuery(){
      const p=qs();
      if(p.get("folder")) folderEl.value=p.get("folder");
      // browser.html passes video=... (mp4)
      if(p.get("video")) fileEl.value=p.get("video");
      if(p.get("file")) fileEl.value=p.get("file");
      if(p.get("start")) startEl.value=p.get("start");
      if(p.get("end")) endEl.value=p.get("end");
      setStatus("Filled from URL query.");
    }

    document.getElementById("fillFromQuery").onclick=fillFromQuery;

    // auto-fill once
    fillFromQuery();

    document.getElementById("go").onclick=async()=>{
      try{
        setWarn("");

        const folder=folderEl.value.trim();
        const file=fileEl.value.trim();
        const startNum=Number(startEl.value);
        const endNum=Number(endEl.value);
        const mode=modeEl.value;
        const crf=String(Number(crfEl.value||23));

        if(!folder || !file) throw new Error("Thi·∫øu folder/file.");
        if(!(endNum > startNum)) throw new Error("end ph·∫£i > start.");
        if(!file.toLowerCase().endsWith(".mp4")) {
          setWarn("Tip: file n√™n l√† .mp4 (workflow c≈©ng ch·ªâ intended cho mp4).");
        }

        const start=String(startNum);
        const end=String(endNum);

        setStatus(
          "Dispatching workflow...\n" +
          "üëâ Sau khi b·∫•m xong, m·ªü Actions ƒë·ªÉ xem log.\n" +
          "üëâ Khi job done, file mp4 s·∫Ω ƒë∆∞·ª£c commit ƒë√® l√™n repo."
        );

        await dispatchWorkflow({ folder, file, start, end, mode, crf });

        setStatus(
          "‚úÖ Dispatched!\n\n" +
          `folder=${folder}\nfile=${file}\nstart=${start}\nend=${end}\nmode=${mode}\ncrf=${crf}\n\n` +
          "M·ªü repo > Actions > workflow 'Trim video and replace' ƒë·ªÉ xem.\n" +
          "Khi runner push xong, quay l·∫°i browser.html b·∫•m Reload."
        );

      } catch(e){
        alert(String(e?.message || e));
      }
    };
</script>
</body>
</html>
