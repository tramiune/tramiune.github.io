<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Orders (Wallpaper)</title>
    <style>
        :root { --bd:#e7e7e7; --mut:#666; }
        body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
        header { padding:12px 14px; border-bottom:1px solid var(--bd); display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
        header b { font-size:14px; }
        header .mut { color:var(--mut); font-size:12px; }
        header input[type="text"], header input[type="password"], header input[type="number"]{
          padding:8px 10px; border:1px solid var(--bd); border-radius:10px; min-width:220px;
        }
        header button, header a.btn {
          padding:8px 10px; border:1px solid var(--bd); background:#fff; border-radius:10px; cursor:pointer;
          text-decoration:none; color:inherit; display:inline-flex; gap:6px; align-items:center;
        }
        header button:hover, header a.btn:hover { background:#f5f5f5; }
        label.mut { display:inline-flex; gap:6px; align-items:center; }
        input[type="checkbox"] { transform: translateY(1px); }

        .wrap { display:grid; grid-template-columns: 280px 1fr; min-height: calc(100vh - 64px); }
        aside { border-right:1px solid var(--bd); padding:10px; overflow:auto; }
        main { padding:12px; overflow:auto; }

        .folder {
          padding:9px 10px; border:1px solid var(--bd); border-radius:12px; cursor:pointer;
          display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;
        }
        .folder:hover { background:#f7f7f7; }
        .folder.active { border-color:#bbb; background:#f5f5f5; }

        .small { font-size:12px; color:var(--mut); }
        .status { font-size:12px; color:var(--mut); white-space:pre-wrap; margin: 6px 0 10px; }

        .list { display:flex; flex-direction:column; gap:8px; }
        .item {
          border:1px solid var(--bd); border-radius:14px; background:#fff;
          padding:10px; display:flex; gap:10px; align-items:flex-start;
        }
        .handle { cursor:grab; user-select:none; padding:2px 8px; border:1px solid var(--bd); border-radius:10px; }
        .pill { font-size:11px; color:#333; background:#f3f3f3; border:1px solid #e2e2e2; padding:2px 8px; border-radius:999px; display:inline-block; }
        .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
        .col { display:flex; flex-direction:column; gap:6px; flex:1; min-width:240px; }
        code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:12px; }
    </style>
</head>
<body>
<header>
    <b>Orders</b>
    <span class="mut">K√©o th·∫£ ƒë·ªÉ s·∫Øp x·∫øp ¬∑ LIVE c√≥ checkbox ch·ªçn preview trong JSON</span>

    <input id="q" type="text" placeholder="Filter folder/item..." />

    <input id="token" type="password" placeholder="GitHub Token (Contents: read)" style="min-width:260px" />
    <label class="mut" title="L∆∞u token tr√™n m√°y b·∫°n (localStorage)">
        <input id="remember" type="checkbox" />
        remember token
    </label>

    <button id="reload">Reload</button>
    <button id="save">üíæ Save (localStorage)</button>
    <button id="resetOrder">‚Ü©Ô∏è Reset order by number</button>

    <a class="btn" href="./browser.html" target="_blank" rel="noreferrer">‚¨ÖÔ∏è Back browser</a>

    <span class="mut" id="rate"></span>
</header>

<div class="wrap">
    <aside>
        <div class="row" style="justify-content:space-between; margin-bottom:8px;">
            <b style="font-size:13px;">Folders</b>
            <span class="small" id="folderCount"></span>
        </div>
        <div id="folders"></div>
    </aside>

    <main>
        <div class="row" style="justify-content:space-between; margin-bottom:8px;">
            <div>
                <b id="title" style="font-size:13px;">Ch·ªçn folder</b><br/>
                <span class="small" id="subtitle"></span>
            </div>
            <div class="small" id="itemCount"></div>
        </div>

        <div class="row" style="margin-bottom:10px;">
            <label class="mut">baseCreatedAt:
                <input id="baseCreatedAt" type="number" min="0" step="1" style="min-width:180px" />
            </label>
            <span class="small">createdAt trong JSON = baseCreatedAt + index theo order</span>
        </div>

        <div class="status" id="status"></div>
        <div class="list" id="list"></div>
    </main>
</div>

<script>
    /** =========================
     *  CONFIG
     *  ========================= */
    const OWNER = "tramiune";
    const REPO  = "tramiune001_res_wallpaper";
    const BRANCH = "main";
    const ROOT_DIR = "resources";

    const IMAGE_EXT = ["webp","png","jpg","jpeg","gif"];
    const VIDEO_EXT = ["mp4","webm","mov"];
    /** ========================= */

    const elFolders = document.getElementById("folders");
    const elList = document.getElementById("list");
    const elStatus = document.getElementById("status");
    const elTitle = document.getElementById("title");
    const elSubtitle = document.getElementById("subtitle");
    const elFolderCount = document.getElementById("folderCount");
    const elItemCount = document.getElementById("itemCount");
    const elQ = document.getElementById("q");
    const elRate = document.getElementById("rate");
    const elToken = document.getElementById("token");
    const elRemember = document.getElementById("remember");
    const elBaseCreatedAt = document.getElementById("baseCreatedAt");

    let allFolders = [];
    let activeFolder = null;
    let activeFiles = [];

    function setStatus(s) { elStatus.textContent = s || ""; }

    function extOf(name) {
      const i = name.lastIndexOf(".");
      return i >= 0 ? name.slice(i+1).toLowerCase() : "";
    }
    function isMediaFile(name) {
      const e = extOf(name);
      return IMAGE_EXT.includes(e) || VIDEO_EXT.includes(e);
    }

    function encodePath(path) { return path.split("/").map(encodeURIComponent).join("/"); }
    function ghContentsUrl(path) {
      const p = encodePath(path);
      return `https://api.github.com/repos/${OWNER}/${REPO}/contents/${p}?ref=${encodeURIComponent(BRANCH)}`;
    }

    function getAuthToken() {
      const t = elToken.value.trim();
      if (!t) throw new Error("B·∫°n ch∆∞a nh·∫≠p GitHub token.");
      return t;
    }

    async function fetchJson(url, withAuth = false) {
      const headers = { "Accept": "application/vnd.github+json" };
      if (withAuth && elToken.value.trim()) headers["Authorization"] = `Bearer ${getAuthToken()}`;

      const res = await fetch(url, { headers });
      const limit = res.headers.get("x-ratelimit-limit");
      const remain = res.headers.get("x-ratelimit-remaining");
      if (limit && remain) elRate.textContent = `GitHub API rate: ${remain}/${limit}`;

      if (!res.ok) {
        const txt = await res.text().catch(()=> "");
        throw new Error(`HTTP ${res.status}\n${txt}`);
      }
      return res.json();
    }

    /** remember token */
    const LS_TOKEN = `wallpaper_orders_token_${OWNER}_${REPO}`;
    (function initRememberToken(){
      const saved = localStorage.getItem(LS_TOKEN);
      if (saved) {
        elToken.value = saved;
        elRemember.checked = true;
      }
      elRemember.addEventListener("change", () => {
        if (elRemember.checked) {
          if (elToken.value.trim()) localStorage.setItem(LS_TOKEN, elToken.value.trim());
        } else {
          localStorage.removeItem(LS_TOKEN);
        }
      });
      elToken.addEventListener("input", () => {
        if (elRemember.checked) localStorage.setItem(LS_TOKEN, elToken.value.trim());
      });
    })();

    /** Orders config storage shared with browser.html */
    const LS_ORDERS = `wallpaper_orders_${OWNER}_${REPO}`;
    function loadOrdersConfig() {
      try {
        const raw = localStorage.getItem(LS_ORDERS);
        if (!raw) return {};
        const obj = JSON.parse(raw);
        return obj && typeof obj === "object" ? obj : {};
      } catch {
        return {};
      }
    }
    function saveOrdersConfig(obj) {
      localStorage.setItem(LS_ORDERS, JSON.stringify(obj, null, 2));
    }

    function isValidStillLiveBase(base) {
      return /^.+?_\d{3}$/i.test(base);
    }

    /** detect items (id list + type) for a folder */
    function detectItems(folderName, files) {
      const fileSet = new Set(files.map(x => x.name));

      const groups = new Map(); // id -> { id, type, n, isLive, hasPreview? }
      const ensure = (id, init) => {
        if (!groups.has(id)) groups.set(id, init);
        return groups.get(id);
      };

      // preview map (for LIVE decision)
      const previewByBase = new Map();
      for (const name of fileSet) {
        if (!name.endsWith("_preview.webp")) continue;
        const base = name.replace("_preview.webp", ".webp");
        previewByBase.set(base, name);
      }

      // DOUBLE
      for (const name of fileSet) {
        const m = name.match(/^double_(\d{3})_(0|1)\.webp$/i);
        if (!m) continue;
        const n = parseInt(m[1], 10);
        const id = `${folderName}_${m[1]}`;
        ensure(id, { id, type: 2, n, isLive:false, hasPreview:false, parts: new Set() }).parts.add(m[2]);
      }

      // DAYS
      for (const name of fileSet) {
        const m = name.match(/^days_(\d{3})_(6h|12h|18h|24h)\.webp$/i);
        if (!m) continue;
        const n = parseInt(m[1], 10);
        const id = `${folderName}_${m[1]}`;
        ensure(id, { id, type: 3, n, isLive:false, hasPreview:false, hours: new Set() }).hours.add(m[2]);
      }

      // COUPLE (only couple_###.webp)
      for (const name of fileSet) {
        const m = name.match(/^couple_(\d{3})\.webp$/i);
        if (!m) continue;
        const n = parseInt(m[1], 10);
        const id = `${folderName}_${m[1]}`;
        ensure(id, { id, type: 4, n, isLive:false, hasPreview: !!previewByBase.get(name) });
      }

      // LIVE/STILL
      const baseMap = new Map(); // base -> { mp4, webp }
      for (const name of fileSet) {
        const e = extOf(name);
        if (e !== "mp4" && e !== "webp") continue;
        if (name.includes("_preview.")) continue;

        const base = name.slice(0, name.lastIndexOf("."));

        // IMPORTANT: ignore couple_001_0.webp etc
        if (/^couple_\d{3}_.+/i.test(base)) continue;
        if (/^double_\d{3}_.+/i.test(name)) continue;
        if (/^days_\d{3}_.+/i.test(name)) continue;

        if (!isValidStillLiveBase(base)) continue;

        const rec = baseMap.get(base) || { mp4:false, webp:false, base };
        if (e === "mp4") rec.mp4 = true;
        if (e === "webp") rec.webp = true;
        baseMap.set(base, rec);
      }

      for (const rec of baseMap.values()) {
        const m = rec.base.match(/_(\d{3})$/);
        if (!m) continue;
        const id = `${folderName}_${m[1]}`;
        if (groups.has(id)) continue; // do not override special types
        const n = parseInt(m[1], 10);

        const webpName = `${rec.base}.webp`;
        const isLive = rec.mp4 && rec.webp;
        const hasPreview = !!previewByBase.get(webpName);

        ensure(id, { id, type: isLive ? 0 : 1, n, isLive, hasPreview });
      }

      // validate special ones (optional)
      // double needs both 0 and 1
      for (const g of groups.values()) {
        if (g.type === 2 && g.parts && g.parts.size < 2) {
          // still keep, but mark
        }
        if (g.type === 3 && g.hours && g.hours.size < 4) {
          // still keep, but mark
        }
      }

      return [...groups.values()].sort((a,b)=> (a.n ?? 0) - (b.n ?? 0));
    }

    function typeLabel(t) {
      if (t === 0) return "LIVE";
      if (t === 1) return "STILL";
      if (t === 2) return "DOUBLE";
      if (t === 3) return "DAYS";
      if (t === 4) return "COUPLE";
      return "UNKNOWN";
    }

    function renderFolders(list) {
      elFolders.innerHTML = "";
      const q = elQ.value.trim().toLowerCase();
      const shown = list.filter(f => f.name.toLowerCase().includes(q));
      elFolderCount.textContent = `${shown.length}/${list.length}`;

      for (const f of shown) {
        const div = document.createElement("div");
        div.className = "folder" + (activeFolder === f.name ? " active" : "");
        div.innerHTML = `<span>üìÅ ${f.name}</span><span class="small">open</span>`;
        div.onclick = () => openFolder(f.name);
        elFolders.appendChild(div);
      }
    }

    function currentFolderCfg() {
      const all = loadOrdersConfig();
      return all[activeFolder] || (all[activeFolder] = { order: [], livePreview: {}, baseCreatedAt: Math.floor(Date.now()/1000) });
    }

    function setBaseCreatedAtUI(val) {
      elBaseCreatedAt.value = String(val ?? Math.floor(Date.now()/1000));
    }

    function getBaseCreatedAtUI() {
      const n = parseInt(elBaseCreatedAt.value, 10);
      return Number.isFinite(n) ? n : Math.floor(Date.now()/1000);
    }

    function renderList(items) {
      elList.innerHTML = "";
      const q = elQ.value.trim().toLowerCase();
      const cfgAll = loadOrdersConfig();
      const cfg = cfgAll[activeFolder] || { order: [], livePreview: {}, baseCreatedAt: Math.floor(Date.now()/1000) };

      // use order array if present, else numeric
      const orderIndex = new Map();
      (cfg.order || []).forEach((id, idx) => orderIndex.set(id, idx));

      const shown = items
        .filter(x => x.id.toLowerCase().includes(q) || typeLabel(x.type).toLowerCase().includes(q))
        .sort((a,b) => {
          const ia = orderIndex.has(a.id) ? orderIndex.get(a.id) : 1e9;
          const ib = orderIndex.has(b.id) ? orderIndex.get(b.id) : 1e9;
          if (ia !== ib) return ia - ib;
          return (a.n ?? 0) - (b.n ?? 0);
        });

      elItemCount.textContent = `Items: ${shown.length}`;

      for (const it of shown) {
        const row = document.createElement("div");
        row.className = "item";
        row.draggable = true;
        row.dataset.id = it.id;

        const handle = document.createElement("div");
        handle.className = "handle";
        handle.textContent = "‚â°";

        const col = document.createElement("div");
        col.className = "col";

        const top = document.createElement("div");
        top.className = "row";
        top.innerHTML = `<span class="pill">${typeLabel(it.type)}</span> <code>${it.id}</code> <span class="small">#${String(it.n).padStart(3,"0")}</span>`;
        col.appendChild(top);

        if (it.type === 0) {
          const line = document.createElement("div");
          line.className = "row";
          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.checked = (cfg.livePreview?.[it.id] !== false); // default true
          cb.disabled = !it.hasPreview; // n·∫øu kh√¥ng c√≥ preview file th√¨ disable
          cb.onchange = () => {
            cfg.livePreview = cfg.livePreview || {};
            cfg.livePreview[it.id] = cb.checked; // true/false
          };
          const label = document.createElement("label");
          label.className = "mut";
          label.appendChild(cb);
          label.appendChild(document.createTextNode(" include preview thumbUrl"));
          line.appendChild(label);

          const hint = document.createElement("span");
          hint.className = "small";
          hint.textContent = it.hasPreview ? "(c√≥ file _preview.webp)" : "(kh√¥ng c√≥ preview file)";
          line.appendChild(hint);

          col.appendChild(line);
        } else {
          const hint = document.createElement("div");
          hint.className = "small";
          hint.textContent = it.type === 4 ? "couple_###.webp (+ optional _preview)" :
                             it.type === 2 ? "double_###_0.webp + double_###_1.webp" :
                             it.type === 3 ? "days_###_6h/12h/18h/24h.webp" :
                             it.type === 1 ? "still: *.webp" : "";
          col.appendChild(hint);
        }

        row.appendChild(handle);
        row.appendChild(col);
        elList.appendChild(row);
      }

      // Drag & drop reordering (updates cfg.order)
      let dragId = null;

      elList.querySelectorAll(".item").forEach(node => {
        node.addEventListener("dragstart", (e) => {
          dragId = node.dataset.id;
          e.dataTransfer.effectAllowed = "move";
        });
        node.addEventListener("dragover", (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = "move";
        });
        node.addEventListener("drop", (e) => {
          e.preventDefault();
          const targetId = node.dataset.id;
          if (!dragId || dragId === targetId) return;

          const ids = [...elList.querySelectorAll(".item")].map(x => x.dataset.id);
          const a = ids.indexOf(dragId);
          const b = ids.indexOf(targetId);
          if (a < 0 || b < 0) return;

          ids.splice(a, 1);
          ids.splice(b, 0, dragId);

          cfg.order = ids;
          cfg.baseCreatedAt = getBaseCreatedAtUI();
          cfgAll[activeFolder] = cfg;
          saveOrdersConfig(cfgAll);

          // rerender
          renderList(items);
        });
      });
    }

    async function loadFolders() {
      setStatus("Loading folders...");
      elTitle.textContent = "Ch·ªçn folder";
      elSubtitle.textContent = `${OWNER}/${REPO}/${ROOT_DIR}`;
      elItemCount.textContent = "";
      elList.innerHTML = "";

      const data = await fetchJson(ghContentsUrl(ROOT_DIR), true);

      allFolders = data
        .filter(x => x.type === "dir")
        .map(x => ({ name: x.name, path: x.path }))
        .sort((a,b) => a.name.localeCompare(b.name, "en"));

      renderFolders(allFolders);
      setStatus("");
    }

    async function openFolder(folderName) {
      activeFolder = folderName;
      renderFolders(allFolders);

      elTitle.textContent = `üìÅ ${folderName}`;
      elSubtitle.textContent = `${ROOT_DIR}/${folderName}`;
      setStatus("Loading files...");
      elList.innerHTML = "";

      const data = await fetchJson(ghContentsUrl(`${ROOT_DIR}/${folderName}`), true);
      activeFiles = data
        .filter(x => x.type === "file")
        .map(x => ({ name: x.name, size: x.size || 0, sha: x.sha }))
        .sort((a,b) => a.name.localeCompare(b.name, "en"));

      const items = detectItems(folderName, activeFiles);

      // init cfg
      const cfgAll = loadOrdersConfig();
      if (!cfgAll[folderName]) {
        cfgAll[folderName] = {
          order: items.map(x => x.id),
          livePreview: {},
          baseCreatedAt: Math.floor(Date.now()/1000)
        };
        saveOrdersConfig(cfgAll);
      } else {
        // ensure every item exists in order
        const cfg = cfgAll[folderName];
        cfg.order = Array.isArray(cfg.order) ? cfg.order : [];
        const set = new Set(cfg.order);
        for (const it of items) if (!set.has(it.id)) cfg.order.push(it.id);
        cfg.livePreview = cfg.livePreview || {};
        if (!Number.isFinite(cfg.baseCreatedAt)) cfg.baseCreatedAt = Math.floor(Date.now()/1000);
        cfgAll[folderName] = cfg;
        saveOrdersConfig(cfgAll);
      }

      setBaseCreatedAtUI(cfgAll[folderName].baseCreatedAt);

      setStatus("");
      renderList(items);
    }

    document.getElementById("reload").onclick = () => loadFolders();

    document.getElementById("save").onclick = () => {
      if (!activeFolder) return alert("Ch·ªçn folder tr∆∞·ªõc.");
      const cfgAll = loadOrdersConfig();
      const cfg = cfgAll[activeFolder] || {};
      cfg.baseCreatedAt = getBaseCreatedAtUI();
      cfgAll[activeFolder] = cfg;
      saveOrdersConfig(cfgAll);
      alert("Saved to localStorage ‚úÖ");
    };

    document.getElementById("resetOrder").onclick = () => {
      if (!activeFolder) return alert("Ch·ªçn folder tr∆∞·ªõc.");
      const items = detectItems(activeFolder, activeFiles);
      const cfgAll = loadOrdersConfig();
      cfgAll[activeFolder] = cfgAll[activeFolder] || { order: [], livePreview: {}, baseCreatedAt: Math.floor(Date.now()/1000) };
      cfgAll[activeFolder].order = items.sort((a,b)=>(a.n??0)-(b.n??0)).map(x => x.id);
      cfgAll[activeFolder].baseCreatedAt = getBaseCreatedAtUI();
      saveOrdersConfig(cfgAll);
      renderList(items);
    };

    elQ.addEventListener("input", () => {
      renderFolders(allFolders);
      if (activeFolder) {
        const items = detectItems(activeFolder, activeFiles);
        renderList(items);
      }
    });

    elBaseCreatedAt.addEventListener("change", () => {
      if (!activeFolder) return;
      const cfgAll = loadOrdersConfig();
      cfgAll[activeFolder] = cfgAll[activeFolder] || {};
      cfgAll[activeFolder].baseCreatedAt = getBaseCreatedAtUI();
      saveOrdersConfig(cfgAll);
    });

    loadFolders().catch(err => setStatus(String(err?.message || err)));
</script>
</body>
</html>
