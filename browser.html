<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wallpaper Browser</title>
  <style>
    :root { --bd:#e7e7e7; --mut:#666; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    header { padding:12px 14px; border-bottom:1px solid var(--bd); display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    header b { font-size:14px; }
    header .mut { color:var(--mut); font-size:12px; }
    header input { padding:8px 10px; border:1px solid var(--bd); border-radius:10px; min-width:220px; }
    header button {
      padding:8px 10px; border:1px solid var(--bd); background:#fff; border-radius:10px; cursor:pointer;
    }
    header button:hover { background:#f5f5f5; }
    .wrap { display:grid; grid-template-columns: 280px 1fr; min-height: calc(100vh - 58px); }
    aside { border-right:1px solid var(--bd); padding:10px; overflow:auto; }
    main { padding:12px; overflow:auto; }
    .folder {
      padding:9px 10px; border:1px solid var(--bd); border-radius:12px; cursor:pointer;
      display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;
    }
    .folder:hover { background:#f7f7f7; }
    .folder.active { border-color:#bbb; background:#f5f5f5; }
    .small { font-size:12px; color:var(--mut); }
    .status { font-size:12px; color:var(--mut); white-space:pre-wrap; margin: 6px 0 10px; }

    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap:10px; }
    .card { border:1px solid var(--bd); border-radius:14px; overflow:hidden; background:#fff; }
    .thumb { width:100%; aspect-ratio: 9/16; background:#f2f2f2; display:flex; align-items:center; justify-content:center; }
    img { width:100%; height:100%; object-fit:cover; display:block; }
    video { width:100%; height:100%; object-fit:cover; display:block; }
    .meta { padding:8px 10px; border-top:1px solid var(--bd); }
    .meta .name { font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .pill { font-size:11px; color:#333; background:#f3f3f3; border:1px solid #e2e2e2; padding:2px 8px; border-radius:999px; display:inline-block; margin-top:6px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    a { color: inherit; }
  </style>
</head>
<body>
<header>
  <b>Wallpaper Browser</b>
  <span class="mut">List folder ‚Üí click ‚Üí show ·∫£nh/video (GitHub API)</span>
  <input id="q" placeholder="Filter folder/file..." />
  <button id="reload">Reload</button>
  <span class="mut" id="rate"></span>
</header>

<div class="wrap">
  <aside>
    <div class="row" style="justify-content:space-between; margin-bottom:8px;">
      <b style="font-size:13px;">Folders</b>
      <span class="small" id="folderCount"></span>
    </div>
    <div id="folders"></div>
  </aside>

  <main>
    <div class="row" style="justify-content:space-between; margin-bottom:8px;">
      <div>
        <b id="title" style="font-size:13px;">Ch·ªçn folder</b><br/>
        <span class="small" id="subtitle"></span>
      </div>
      <div class="small" id="itemCount"></div>
    </div>

    <div class="status" id="status"></div>
    <div class="grid" id="grid"></div>
  </main>
</div>

<script>
/** =========================
 *  CONFIG ‚Äì s·ª≠a ·ªü ƒë√¢y
 *  ========================= */
const OWNER = "tramiune";
const REPO  = "tramiune001_res_wallpaper";
const BRANCH = "main"; // ho·∫∑c "master"
const ROOT_DIR = "resources"; // n∆°i ch·ª©a c√°c folder 101_anime...
// Url media: d√πng jsDelivr (nhanh + cache). C√≥ th·ªÉ ƒë·ªïi sang raw.githubusercontent n·∫øu mu·ªën.
const CDN_BASE = `https://cdn.jsdelivr.net/gh/${OWNER}/${REPO}/${ROOT_DIR}/`;

/** file extensions mu·ªën show */
const IMAGE_EXT = ["webp","png","jpg","jpeg","gif"];
const VIDEO_EXT = ["mp4","webm","mov"];

/** ========================= */

const elFolders = document.getElementById("folders");
const elGrid = document.getElementById("grid");
const elStatus = document.getElementById("status");
const elTitle = document.getElementById("title");
const elSubtitle = document.getElementById("subtitle");
const elFolderCount = document.getElementById("folderCount");
const elItemCount = document.getElementById("itemCount");
const elQ = document.getElementById("q");
const elRate = document.getElementById("rate");

let allFolders = [];
let activeFolder = null;
let activeFiles = [];

function setStatus(s) { elStatus.textContent = s || ""; }

function extOf(name) {
  const i = name.lastIndexOf(".");
  return i >= 0 ? name.slice(i+1).toLowerCase() : "";
}

function isMediaFile(name) {
  const e = extOf(name);
  return IMAGE_EXT.includes(e) || VIDEO_EXT.includes(e);
}

function isPreviewName(name) {
  // v√≠ d·ª•: anime_001_preview.webp
  return name.includes("_preview.");
}

function ghApi(path) {
  // Contents API: list th∆∞ m·ª•c
  return `https://api.github.com/repos/${OWNER}/${REPO}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(BRANCH)}`;
}

async function fetchJson(url) {
  const res = await fetch(url, { headers: { "Accept": "application/vnd.github+json" } });
  // show rate limit info
  const limit = res.headers.get("x-ratelimit-limit");
  const remain = res.headers.get("x-ratelimit-remaining");
  if (limit && remain) elRate.textContent = `GitHub API rate: ${remain}/${limit}`;
  if (!res.ok) {
    const txt = await res.text().catch(()=> "");
    throw new Error(`HTTP ${res.status} when GET ${url}\n${txt}`);
  }
  return res.json();
}

function renderFolders(list) {
  elFolders.innerHTML = "";
  const q = elQ.value.trim().toLowerCase();

  const shown = list.filter(f => f.name.toLowerCase().includes(q));
  elFolderCount.textContent = `${shown.length}/${list.length}`;

  for (const f of shown) {
    const div = document.createElement("div");
    div.className = "folder" + (activeFolder === f.name ? " active" : "");
    div.innerHTML = `<span>üìÅ ${f.name}</span><span class="small">open</span>`;
    div.onclick = () => openFolder(f.name);
    elFolders.appendChild(div);
  }
}

function mediaUrl(folderName, fileName) {
  return `${CDN_BASE}${folderName}/${fileName}`;
}

function renderGrid(files) {
  elGrid.innerHTML = "";
  const q = elQ.value.trim().toLowerCase();

  // build set preview: map baseName -> preview file if exists
  const previewByBase = new Map();
  for (const f of files) {
    if (!isMediaFile(f.name)) continue;
    if (!isPreviewName(f.name)) continue;
    // base: anime_001.webp -> anime_001_preview.webp
    const base = f.name.replace("_preview.", ".");
    previewByBase.set(base, f.name);
  }

  const shown = files
    .filter(f => isMediaFile(f.name))
    .filter(f => f.name.toLowerCase().includes(q))
    .filter(f => !isPreviewName(f.name)); // kh√¥ng show ri√™ng preview

  elItemCount.textContent = `Items: ${shown.length}`;

  for (const f of shown) {
    const e = extOf(f.name);
    const card = document.createElement("div");
    card.className = "card";

    const thumb = document.createElement("div");
    thumb.className = "thumb";

    // n·∫øu l√† webp/jpg/png... v√† c√≥ preview th√¨ ∆∞u ti√™n preview
    const maybePreview = previewByBase.get(f.name);
    const url = (maybePreview && IMAGE_EXT.includes(e))
      ? mediaUrl(activeFolder, maybePreview)
      : mediaUrl(activeFolder, f.name);

    if (VIDEO_EXT.includes(e)) {
      const v = document.createElement("video");
      v.src = url;
      v.controls = true;
      v.muted = true;
      v.playsInline = true;
      v.preload = "metadata";
      thumb.appendChild(v);
    } else {
      const img = document.createElement("img");
      img.loading = "lazy";
      img.src = url;
      img.alt = f.name;
      thumb.appendChild(img);
    }

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.innerHTML = `
      <div class="name" title="${f.name}">${f.name}</div>
      <div class="pill">${VIDEO_EXT.includes(e) ? "video" : "image"} ¬∑ ${e}</div>
      <div class="small" style="margin-top:6px;">
        <a href="${mediaUrl(activeFolder, f.name)}" target="_blank" rel="noreferrer">open file</a>
      </div>
    `;

    card.appendChild(thumb);
    card.appendChild(meta);
    elGrid.appendChild(card);
  }
}

async function loadFolders() {
  setStatus("Loading folders...");
  elTitle.textContent = "Ch·ªçn folder";
  elSubtitle.textContent = `${OWNER}/${REPO}/${ROOT_DIR}`;
  elItemCount.textContent = "";
  elGrid.innerHTML = "";

  const data = await fetchJson(ghApi(ROOT_DIR));
  // ch·ªâ l·∫•y th∆∞ m·ª•c
  allFolders = data
    .filter(x => x.type === "dir")
    .map(x => ({ name: x.name, path: x.path }))
    .sort((a,b) => a.name.localeCompare(b.name, "en"));

  renderFolders(allFolders);
  setStatus("");
}

async function openFolder(folderName) {
  activeFolder = folderName;
  renderFolders(allFolders);

  elTitle.textContent = `üìÅ ${folderName}`;
  elSubtitle.textContent = `${ROOT_DIR}/${folderName}`;
  setStatus("Loading files...");
  elGrid.innerHTML = "";

  const path = `${ROOT_DIR}/${folderName}`;
  const data = await fetchJson(ghApi(path));

  activeFiles = data
    .filter(x => x.type === "file")
    .map(x => ({ name: x.name, size: x.size || 0 }))
    .sort((a,b) => a.name.localeCompare(b.name, "en"));

  setStatus("");
  renderGrid(activeFiles);
}

document.getElementById("reload").onclick = () => loadFolders();
elQ.addEventListener("input", () => {
  renderFolders(allFolders);
  if (activeFolder) renderGrid(activeFiles);
});

loadFolders().catch(err => setStatus(String(err)));
</script>
</body>
</html>
